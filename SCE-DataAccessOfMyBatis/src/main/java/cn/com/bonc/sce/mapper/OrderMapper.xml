<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.bonc.sce.mapper.OrderMapper">

    <insert id="insertOrder" parameterType="map">
        insert into STARCLOUDPORTAL.SCE_ORDER_INFO(ORDER_ID,PAYING_TYPE,ORDER_CREATE_TIME,BUYING_USER_ID,
        PRODUCT_NAME,PRODUCT_ID,PRICE_CALCULATION_METHOD,ORIGIN_PRICE,DISCOUNT_MODE,DISCOUNT_PRICE,ACCOUNT_PAYABLE,
        ACTUAL_PAYMENT,PAYMENT_VOUCHER,ORDER_STATUS,IS_DELETE,COUPON_CODE,PRODUCT_TYPE_CODE,ORDER_DEADLINE_TIME,STATE_UPDATE_TIME)
        values (#{ORDER_ID,jdbcType=NUMERIC},#{PAYING_TYPE,jdbcType=NUMERIC},#{ORDER_CREATE_TIME,jdbcType=VARCHAR},
        #{BUYING_USER_ID,jdbcType=VARCHAR},#{PRODUCT_NAME,jdbcType=VARCHAR},#{PRODUCT_ID,jdbcType=VARCHAR},
        #{PRICE_CALCULATION_METHOD,jdbcType=NUMERIC},#{ORIGIN_PRICE,jdbcType=NUMERIC},#{DISCOUNT_MODE,jdbcType=VARCHAR},
        #{DISCOUNT_PRICE,jdbcType=NUMERIC},#{ACCOUNT_PAYABLE,jdbcType=NUMERIC},#{ACTUAL_PAYMENT,jdbcType=NUMERIC},
        #{PAYMENT_VOUCHER,jdbcType=NUMERIC},#{ORDER_STATUS,jdbcType=NUMERIC},#{IS_DELETE,jdbcType=NUMERIC},
        #{COUPON_CODE,jdbcType=VARCHAR},#{PRODUCT_TYPE_CODE,jdbcType=NUMERIC},#{ORDER_DEADLINE_TIME,jdbcType=VARCHAR},#{STATE_UPDATE_TIME,jdbcType=VARCHAR})
    </insert>

    <insert id="insertOrderHistroy">
        INSERT INTO STARCLOUDPORTAL.SCE_ORDER_HISTORY(ORDER_ID,STATUS_UPDATE_TIME,ORDER_STATUS)
        VALUES (#{ORDER_ID,jdbcType=NUMERIC},#{STATUS_UPDATE_TIME,jdbcType=VARCHAR},#{ORDER_STATUS,jdbcType=NUMERIC})
    </insert>

    <select id="queryOrderByOrderID" resultType="map">
        SELECT ORDERINFO.ORDER_ID,ORDERINFO.ORDER_STATUS,ORDERINFO.PAYING_TYPE,
        ORDERINFO.ORIGIN_PRICE,ORDERINFO.DISCOUNT_PRICE,ORDERINFO.ACTUAL_PAYMENT,
        TO_CHAR(ONLINEORDER.PAYING_TIME,'yyyy-MM-dd HH24:mi:ss') AS ONLINE_PAYMENT_TIME,
        TO_CHAR(OFFLINEORDER.UPLOAD_TIME,'yyyy-MM-dd HH24:mi:ss') AS OFFLINE_PAYMENT_TIME,
        ORDERINFO.COUPON_CODE,COUPONTYPEDIC.COUPON_TYPE_NAME,



       USERINFO.USER_ID,USERROLE.ROLE_NAME,USERINFO.USER_NAME,USERINFO.LOGIN_NAME,USERINFO.PHONE_NUMBER,
       TO_CHAR(USERINFO.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS USER_CREATE_TIME,


      APPVERSION.APP_ID,APPVERSION.APP_NAME,APPVERSION.APP_ICON,APPVERSION.VERSION_INFO,
      TO_CHAR(APPVERSION.AUDIT_TIME,'yyyy-MM-dd HH24:mi:ss') AS APP_AUDIT_TIME,
      MARKETPRICEMODE.MODE_NAME,MARKETPRICEMODE.MODE_DESC,MARKETPRICEMODE.MODE_PRICE,COMPANY.COMPANY_NAME,


      ORDERINVOICEINFO.INVOICE_TYPE,ORDERINVOICEINFO.INVOICE_CONTENT,ORDERINVOICEINFO.INVOICE_TITLE,ORDERINVOICEINFO.RECIPIENTS,
      ORDERINVOICEINFO.INVOICE_STATUS

      FROM STARCLOUDPORTAL.SCE_ORDER_INFO ORDERINFO
      LEFT JOIN STARCLOUDPORTAL.SCE_COUPON COUPONINFO ON ORDERINFO.COUPON_CODE = COUPONINFO.COUPON_CODE
      LEFT JOIN STARCLOUDPORTAL.SCE_COUPON_TYPE_DIC COUPONTYPEDIC ON COUPONINFO.COUPON_TYPE_CODE = COUPONTYPEDIC.COUPON_TYPE_CODE
      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_PAYMENT ONLINEORDER ON ORDERINFO.ORDER_ID = ONLINEORDER.ORDER_ID
      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_VOUCHER OFFLINEORDER ON ORDERINFO.ORDER_ID = OFFLINEORDER.ORDER_ID


      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_PRICE_MODE MARKETPRICEMODE ON ORDERINFO.PRICE_CALCULATION_METHOD = MARKETPRICEMODE.ID
      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_APP_VERSION APPVERSION ON MARKETPRICEMODE.APP_ID = APPVERSION.APP_ID
      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_APP_INFO APPINFO ON APPVERSION.APP_ID = APPINFO.APP_ID
      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_COMPANY COMPANY ON APPINFO.COMPANY_ID = COMPANY.COMPANY_ID


      LEFT JOIN STARCLOUDPORTAL.SCE_COMMON_USER USERINFO ON ORDERINFO.BUYING_USER_ID = USERINFO.USER_ID
      LEFT JOIN STARCLOUDPORTAL.SCE_COMMON_USER_ROLE USERROLE ON USERROLE.ROLE_ID = USERINFO.USER_TYPE

      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_INVOICE_REL ORDERINVOICEREL ON ORDERINFO.ORDER_ID = ORDERINVOICEREL.ORDER_ID
      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_INVOICE_INFO ORDERINVOICEINFO ON ORDERINVOICEINFO.ID = ORDERINVOICEREL.ORDER_INVOICE_ID



      WHERE ORDERINFO.ORDER_ID = #{ORDER_ID}
    </select>

    <update id="updateOrderByOrderID" parameterType="map">
        update STARCLOUDPORTAL.SCE_ORDER_INFO set ORDER_ID = #{ORDER_ID}
        <if test='PAYING_TYPE != null and PAYING_TYPE != ""'>
            ,PAYING_TYPE = #{PAYING_TYPE}
        </if>

        <if test='ORDER_CREATE_TIME != null and ORDER_CREATE_TIME != ""'>
            ,ORDER_CREATE_TIME = #{ORDER_CREATE_TIME}
        </if>

        <if test='PRODUCT_NAME != null and PRODUCT_NAME != ""'>
            ,PRODUCT_NAME = #{PRODUCT_NAME}
        </if>

        <if test='PRODUCT_ID != null and PRODUCT_ID != ""'>
            ,PRODUCT_ID = #{PRODUCT_ID}
        </if>

        <if test='PRICE_CALCULATION_METHOD != null and PRICE_CALCULATION_METHOD != ""'>
            ,PRICE_CALCULATION_METHOD = #{PRICE_CALCULATION_METHOD}
        </if>

        <if test='ORIGIN_PRICE != null and ORIGIN_PRICE != ""'>
            ,ORIGIN_PRICE = #{ORIGIN_PRICE}
        </if>

        <if test='DISCOUNT_MODE != null and DISCOUNT_MODE != ""'>
            ,DISCOUNT_MODE = #{DISCOUNT_MODE}
        </if>

        <if test='DISCOUNT_PRICE != null and DISCOUNT_PRICE != ""'>
            ,DISCOUNT_PRICE = #{DISCOUNT_PRICE}
        </if>

        <if test='ACCOUNT_PAYABLE != null and ACCOUNT_PAYABLE != ""'>
            ,ACCOUNT_PAYABLE = #{ACCOUNT_PAYABLE}
        </if>

        <if test='ACTUAL_PAYMENT != null and ACTUAL_PAYMENT != ""'>
            ,ACTUAL_PAYMENT = #{ACTUAL_PAYMENT}
        </if>

        <if test='PAYMENT_VOUCHER != null and PAYMENT_VOUCHER != ""'>
            ,PAYMENT_VOUCHER = #{PAYMENT_VOUCHER}
        </if>

        <if test='ORDER_STATUS != null and ORDER_STATUS != ""'>
            ,ORDER_STATUS = #{ORDER_STATUS}
        </if>

        <if test='IS_DELETE != null and IS_DELETE != ""'>
            ,IS_DELETE = #{IS_DELETE}
        </if>

        <if test='COUPON_CODE != null and COUPON_CODE != ""'>
            ,COUPON_CODE = #{COUPON_CODE}
        </if>

        <if test='PRODUCT_TYPE_CODE != null and PRODUCT_TYPE_CODE != ""'>
            ,PRODUCT_TYPE_CODE = #{PRODUCT_TYPE_CODE}
        </if>

        <if test='ORDER_DEADLINE_TIME != null and ORDER_DEADLINE_TIME != ""'>
            ,ORDER_DEADLINE_TIME = #{ORDER_DEADLINE_TIME}
        </if>

        <if test='BUYING_USER_ID != null and BUYING_USER_ID != ""'>
            ,BUYING_USER_ID = #{BUYING_USER_ID}
        </if>

        <if test='STATE_UPDATE_TIME != null and STATE_UPDATE_TIME != ""'>
            ,STATE_UPDATE_TIME = #{STATE_UPDATE_TIME}
        </if>
        where ORDER_ID = #{ORDER_ID}
    </update>

    <update id="updateOrderScheduled">
        update STARCLOUDPORTAL.SCE_ORDER_INFO set ORDER_STATUS = 3 , ACCOUNT_ENTRY_TIME = sysdate
        where ORDER_STATUS = 1 AND IS_DELETE = 1
    </update>

    <insert id="insertOrderVoucher" parameterType="map">
        INSERT INTO STARCLOUDPORTAL.SCE_ORDER_VOUCHER (ID,ORDER_ID,PAYING_VOUCHER,AUDITING_STATUS,UPLOAD_TIME,UPLOAD_USER_ID,IS_DELETE)
        VALUES (#{ID,jdbcType=NUMERIC},#{ORDER_ID,jdbcType=NUMERIC},#{PAYING_VOUCHER,jdbcType=NUMERIC},0,
                #{UPLOAD_TIME,jdbcType=VARCHAR},#{UPLOAD_USER_ID,jdbcType=VARCHAR},1)
    </insert>

    <update id="updateOrderVoucher" parameterType="map">
        UPDATE STARCLOUDPORTAL.SCE_ORDER_VOUCHER SET AUDITING_STATUS = #{AUDITING_STATUS},
        AUDITING_USER_ID=#{AUDITING_USER_ID}, REVIEW_TIME = #{REVIEW_TIME}

        <if test='REJECT_REASON != null and REJECT_REASON != ""'>
            ,REJECT_REASON = #{REJECT_REASON}
        </if>

        WHERE ID=#{ID} AND ORDER_ID = #{ORDER_ID}
    </update>


    <update id="deleteOrderVoucher">
        UPDATE STARCLOUDPORTAL.SCE_ORDER_VOUCHER SET IS_DELETE = 0
        WHERE  ORDER_ID = #{ORDER_ID}
    </update>

    <select id="queryAllOrderByCondition" resultType="map">
        SELECT ORDERINFO.ORDER_ID,ORDERINFO.PRODUCT_NAME,ORDERINFO.ORIGIN_PRICE,ORDERINFO.ACCOUNT_PAYABLE,ORDERINFO.ACTUAL_PAYMENT,
               ORDERINFO.PAYING_TYPE,ORDERINFO.ORDER_STATUS,TO_CHAR(ORDERINFO.STATE_UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS STATE_UPDATE_TIME,
               USERINFO.USER_NAME,USERINFO.LOGIN_NAME,TO_CHAR(ORDERINFO.ORDER_CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS ORDER_CREATE_TIME,

               VOUCHER.PAYING_VOUCHER,FILERESOURCE.RESOURCE_ID,FILERESOURCE.FILE_STORE_PATH
      FROM STARCLOUDPORTAL.SCE_ORDER_INFO ORDERINFO
      LEFT JOIN STARCLOUDPORTAL.SCE_COMMON_USER USERINFO ON ORDERINFO.BUYING_USER_ID = USERINFO.USER_ID

      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_VOUCHER VOUCHER ON ORDERINFO.ORDER_ID = VOUCHER.ORDER_ID
      LEFT JOIN STARCLOUDPORTAL.SCE_FILE_RESOURCE FILERESOURCE ON VOUCHER.PAYING_VOUCHER = FILERESOURCE.RESOURCE_ID

      WHERE ORDERINFO.IS_DELETE = 1
        <if test='ORDER_ID != null and ORDER_ID != ""'>
            AND ORDERINFO.ORDER_ID LIKE  CONCAT('%', CONCAT(#{ORDER_ID}, '%'))
        </if>

        <if test='START_TIME != null and START_TIME != ""'>
            AND ORDERINFO.ORDER_CREATE_TIME > #{START_TIME}
        </if>

        <if test='END_TIME != null and END_TIME != ""'>
            AND  #{END_TIME} > ORDERINFO.ORDER_CREATE_TIME
        </if>

        <if test='PRODUCT_TYPE_CODE != null and PRODUCT_TYPE_CODE != ""'>
            AND  ORDERINFO.PRODUCT_TYPE_CODE = #{PRODUCT_TYPE_CODE}
        </if>

        <if test='PAYING_TYPE != null and PAYING_TYPE != ""'>
            AND  ORDERINFO.PAYING_TYPE = #{PAYING_TYPE}
        </if>

        <if test='ORDER_STATUS != null and ORDER_STATUS != ""'>
            AND  ORDERINFO.ORDER_STATUS = #{ORDER_STATUS}
        </if>

        <if test='ORDER_BY == "1"'>
            order by ORDERINFO.ORDER_ID asc
        </if>

        <if test='ORDER_BY == "2"'>
            order by ORDERINFO.ORDER_ID desc
        </if>

        <if test='ORDER_BY == "3"'>
            order by ORDERINFO.PRODUCT_NAME asc
        </if>

        <if test='ORDER_BY == "4"'>
            order by ORDERINFO.PRODUCT_NAME desc
        </if>

        <if test='ORDER_BY == "5"'>
            order by ORDERINFO.ORIGIN_PRICE asc
        </if>

        <if test='ORDER_BY == "6"'>
            order by ORDERINFO.ORIGIN_PRICE desc
        </if>

        <if test='ORDER_BY == "7"'>
            order by ORDERINFO.PAYING_TYPE asc
        </if>

        <if test='ORDER_BY == "8"'>
            order by ORDERINFO.PAYING_TYPE desc
        </if>

        <if test='ORDER_BY == "9"'>
            order by ORDERINFO.ORDER_STATUS asc
        </if>

        <if test='ORDER_BY == "10"'>
            order by ORDERINFO.ORDER_STATUS desc
        </if>

        <if test='ORDER_BY == "11"'>
            order by STATE_UPDATE_TIME asc
        </if>

        <if test='ORDER_BY == "12"'>
            order by STATE_UPDATE_TIME desc
        </if>

        <if test='ORDER_BY == "13"'>
            order by USERINFO.USER_NAME asc
        </if>

        <if test='ORDER_BY == "14"'>
            order by USERINFO.USER_NAME desc
        </if>

        <if test='ORDER_BY == "15"'>
            order by ORDER_CREATE_TIME asc
        </if>

        <if test='ORDER_BY == "16"'>
            order by ORDER_CREATE_TIME desc
        </if>


    </select>

    <select id="queryOrderByUserId" resultType="map">
        SELECT ORDERINFO.ORDER_ID,ORDERINFO.ORIGIN_PRICE,ORDERINFO.ACCOUNT_PAYABLE,ORDERINFO.ACTUAL_PAYMENT,
               ORDERINFO.PAYING_TYPE,ORDERINFO.ORDER_STATUS,TO_CHAR(ORDERINFO.STATE_UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS STATE_UPDATE_TIME,
               TO_CHAR(ORDERINFO.ORDER_CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS ORDER_CREATE_TIME,

               ORDERINFO.PRICE_CALCULATION_METHOD AS MARKETPRICEMODE_ID,MARKETPRICEMODE.APP_ID,APPVERSION.APP_NAME,APPVERSION.APP_ICON,APPVERSION.VERSION_INFO,
               MARKETPRICEMODE.APP_VERSION,MARKETPRICEMODE.MODE_NAME,

               NVL(VOUCHER.AUDITING_STATUS, 999) AS AUDITING_STATUS,
               CASE WHEN NVL(VOUCHER.AUDITING_STATUS, 999) = 0 THEN '凭证待审核'
                    WHEN NVL(VOUCHER.AUDITING_STATUS, 999) = 1 THEN '凭证待审通过'
                    WHEN NVL(VOUCHER.AUDITING_STATUS, 999) = 2 THEN '凭证待审不通过'
              ELSE '凭证未上传' END AS AUDITING_STATUS_DEF
      FROM STARCLOUDPORTAL.SCE_ORDER_INFO ORDERINFO

      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_PRICE_MODE MARKETPRICEMODE ON ORDERINFO.PRICE_CALCULATION_METHOD = MARKETPRICEMODE.ID
      LEFT JOIN STARCLOUDMARKET.SCE_MARKET_APP_VERSION APPVERSION ON MARKETPRICEMODE.APP_ID = APPVERSION.APP_ID

      LEFT JOIN STARCLOUDPORTAL.SCE_ORDER_VOUCHER VOUCHER ON ORDERINFO.ORDER_ID = VOUCHER.ORDER_ID

      WHERE ORDERINFO.IS_DELETE = 1

        <if test='KEYWORD != null and KEYWORD != ""'>
            AND  (ORDERINFO.ORDER_ID LIKE  CONCAT('%', CONCAT(#{KEYWORD}, '%')) or
                  APPVERSION.APP_NAME LIKE  CONCAT('%', CONCAT(#{KEYWORD}, '%')) )
        </if>

        <if test='ORDER_STATUS != null and ORDER_STATUS != ""'>
            AND  ORDERINFO.ORDER_STATUS = #{ORDER_STATUS}
        </if>

        <if test='USER_ID != null and USER_ID != ""'>
            AND  ORDERINFO.BUYING_USER_ID = #{USER_ID}
        </if>

        <if test='ORDER_BY == "1"'>
            order by ORDERINFO.ORIGIN_PRICE asc
        </if>

        <if test='ORDER_BY == "2"'>
            order by ORDERINFO.ORIGIN_PRICE desc
        </if>

    </select>

</mapper>